<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>心灯AI</title>
  <style>
    body{font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans JP","Hiragino Kaku Gothic ProN","Yu Gothic",sans-serif;max-width:820px;margin:26px auto;padding:0 14px;line-height:1.7}
    h1{font-size:24px;margin:0 0 14px}
    .box{border:1px solid #ddd;border-radius:14px;padding:14px}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-top:10px}
    input,textarea{width:100%;box-sizing:border-box;border:1px solid #ccc;border-radius:12px;padding:10px;font-size:16px}
    textarea{min-height:120px;resize:vertical}
    button{border:0;border-radius:12px;padding:10px 14px;font-size:16px;cursor:pointer;background:#111;color:#fff}
    button.secondary{background:#eee;color:#111}
    button:disabled{opacity:.5;cursor:not-allowed}
    .muted{color:#666;font-size:13px}
    .pill{display:inline-flex;align-items:center;gap:8px;border:1px solid #ddd;border-radius:999px;padding:6px 10px;font-size:13px}
    .ok{color:#0a7}
    .ng{color:#d33}
    pre{white-space:pre-wrap;word-break:break-word;background:#fafafa;border:1px solid #eee;border-radius:12px;padding:12px;margin-top:12px}
    .grid{display:grid;grid-template-columns:1fr;gap:12px}
    @media(min-width:760px){.grid{grid-template-columns:1fr 1fr}}
  </style>
</head>
<body>
  <h1>心灯AI</h1>

  <div class="box">
    <div class="muted">まずはログイン（メール）→ ログインできたら、質問が送れるようになります。</div>

    <div class="grid" style="margin-top:10px">
      <div>
        <div class="muted">メールアドレス</div>
        <input id="email" type="email" placeholder="example@gmail.com" />
        <div class="row">
          <button id="btnSendLink">ログインリンクを送る</button>
          <button id="btnLogout" class="secondary" disabled>ログアウト</button>
          <span id="authState" class="pill">未ログイン</span>
        </div>
        <div class="muted" style="margin-top:6px">
          ※メールが届いたらリンクを開く → 自動でこのページに戻ってログイン完了します。
        </div>
      </div>

      <div>
        <div class="muted">アカウント</div>
        <div class="pill" style="width:100%;justify-content:space-between">
          <span>UID</span>
          <span id="uid" class="muted">-</span>
        </div>
        <div class="pill" style="width:100%;justify-content:space-between;margin-top:8px">
          <span>残り回数</span>
          <span id="tickets" class="muted">-</span>
        </div>
      </div>
    </div>

    <hr style="border:none;border-top:1px solid #eee;margin:14px 0">

    <div class="muted">相談や質問を書いて「送信」を押してください。心を整える言葉をお返しします。</div>
    <textarea id="text" placeholder="例：好きな人がいるけど、気持ちが伝わらない"></textarea>

    <div class="row">
      <button id="send" disabled>送信</button>
      <span id="state" class="muted"></span>
    </div>

    <pre id="out">（ここに返答が出ます）</pre>
  </div>

  <!-- Supabase JS (CDN) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <script>
    // ====== ここをあなたの値に置き換える ======
    const SUPABASE_URL = "https://jaxfvwzvhvbenrcrgduy.supabase.co";
    const SUPABASE_ANON_KEY = "sb_publishable_1MOnC3nmYzLMuswWc6qgvw_AaEjxE6W";
    // =======================================

    const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // あなたの Edge Function（すでにあるやつ）
    const FUNCTION_URL = "https://jaxfvwzvhvbenrcrgduy.supabase.co/functions/v1/kokorobi-ai";

    const $ = (id) => document.getElementById(id);

    function setAuthUI(user){
      if(user){
        $("authState").textContent = "ログイン中";
        $("authState").classList.remove("ng");
        $("authState").classList.add("ok");
        $("btnLogout").disabled = false;
        $("send").disabled = false;
        $("uid").textContent = user.id;
      }else{
        $("authState").textContent = "未ログイン";
        $("authState").classList.remove("ok");
        $("authState").classList.add("ng");
        $("btnLogout").disabled = true;
        $("send").disabled = true;
        $("uid").textContent = "-";
        $("tickets").textContent = "-";
      }
    }

    async function refreshSession(){
      const { data } = await sb.auth.getSession();
      setAuthUI(data?.session?.user || null);
      if(data?.session?.user){
        await loadTickets();
      }
    }

    // ここはBにも直結：profiles.ticket_count を読む
    async function loadTickets(){
      const { data: { user } } = await sb.auth.getUser();
      if(!user) return;

      const { data, error } = await sb
        .from("profiles")
        .select("ticket_count")
        .eq("user_id", user.id)
        .maybeSingle();

      if(error){
        $("tickets").textContent = "取得エラー";
        return;
      }
      // 初回ユーザーでprofilesがまだ無いなら表示だけ0
      $("tickets").textContent = (data?.ticket_count ?? 0);
    }

    // ---- A：マジックリンク送信
    $("btnSendLink").addEventListener("click", async () => {
      const email = $("email").value.trim();
      if(!email){
        alert("メールアドレスを入力してね");
        return;
      }
      $("btnSendLink").disabled = true;
      $("authState").textContent = "送信中…";
      try{
        const { error } = await sb.auth.signInWithOtp({
          email,
          options: {
            emailRedirectTo: window.location.origin + window.location.pathname
          }
        });
        if(error) throw error;
        $("authState").textContent = "メールを確認してね";
        $("authState").classList.add("ok");
      }catch(e){
        console.error(e);
        $("authState").textContent = "送信失敗";
        $("authState").classList.add("ng");
        alert("送信に失敗しました。Email設定（Confirm email）やURL設定を確認してね。");
      }finally{
        $("btnSendLink").disabled = false;
      }
    });

    $("btnLogout").addEventListener("click", async () => {
      await sb.auth.signOut();
      setAuthUI(null);
      $("out").textContent = "（ここに返答が出ます）";
    });

    // ---- 返信（あなたのFunctionへ）
    $("send").addEventListener("click", async () => {
      const userText = $("text").value.trim();
      if(!userText) return;

      $("state").textContent = "送信中…";
      $("out").textContent = "";

      try{
        // 認証付きでFunctionを叩く（ログイン必須にするため）
        const { data: { session } } = await sb.auth.getSession();
        const token = session?.access_token;
        if(!token){
          alert("ログインしてください");
          setAuthUI(null);
          return;
        }

        const res = await fetch(FUNCTION_URL, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": "Bearer " + token
          },
          body: JSON.stringify({ text: userText })
        });

        const json = await res.json();
        if(!res.ok){
          throw new Error(json?.error || "通信エラー");
        }
        $("out").textContent = json.reply || "（返答が空でした）";

        // 次ステップで「1回消費」も入れられる（今は表示だけ）
        await loadTickets();

      }catch(e){
        console.error(e);
        $("out").textContent = "通信エラーが発生しました";
      }finally{
        $("state").textContent = "";
      }
    });

    // ページ読み込み時：ログイン復元
    sb.auth.onAuthStateChange((_event, _session) => {
      refreshSession();
    });
    refreshSession();
  </script>
</body>
</html>
