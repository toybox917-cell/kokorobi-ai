<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>心灯AI</title>

  <style>
    body{
      font-family:
        system-ui,
        -apple-system,
        BlinkMacSystemFont,
        "Segoe UI",
        Roboto,
        "Noto Sans JP",
        "Hiragino Kaku Gothic ProN",
        "Yu Gothic",
        sans-serif;
      max-width: 720px;
      margin: 24px auto;
      padding: 0 14px;
      line-height: 1.7;
      background:#fff;
      color:#222;
    }

    h1{
      font-size: 26px;
      margin-bottom: 16px;
    }

    .box{
      border:1px solid #ddd;
      border-radius:14px;
      padding:16px;
    }

    .muted{
      color:#666;
      font-size:14px;
      margin-bottom:8px;
    }

    textarea{
      width:100%;
      min-height:140px;
      border:1px solid #ccc;
      border-radius:12px;
      padding:12px;
      font-size:16px;
      resize:vertical;
      box-sizing:border-box;
    }

    button{
      border:none;
      border-radius:12px;
      padding:12px 18px;
      font-size:16px;
      cursor:pointer;
      background:#f0f0f0;
    }

    button:hover{
      background:#e6e6e6;
    }

    .row{
      display:flex;
      align-items:center;
      gap:12px;
      margin-top:14px;
    }

    #state{
      font-size:14px;
      color:#666;
    }

    pre{
      white-space:pre-wrap;
      word-break:break-word;
      background:#fafafa;
      border:1px solid #eee;
      border-radius:12px;
      padding:14px;
      margin-top:16px;
      font-size:15px;
    }
  </style>
</head>

<body>

  <h1>心灯AI</h1>

  <div class="box">
    <div class="muted">
      相談や質問を書いて「送信」を押してください。<br>
      心を整える言葉をお返しします。
    </div>

    <textarea
      id="text"
      placeholder="例：好きな人がいるけど、気持ちが伝わらない"
    ></textarea>

    <div class="row">
      <button id="send">送信</button>
      <span id="state"></span>
    </div>

    <pre id="result">(ここに返答が出ます)</pre>
  </div>

<script>
const ENDPOINT =
  "https://jaxfvwzvhvbenrcrgduy.supabase.co/functions/v1/kokorobi-ai";

const sendBtn = document.getElementById("send");
const textEl  = document.getElementById("text");
const result  = document.getElementById("result");
const state   = document.getElementById("state");

sendBtn.onclick = async () => {
  const text = textEl.value.trim();
  if(!text){
    alert("文章を入力してください");
    return;
  }

  state.textContent = "考えています…";
  result.textContent = "";

  try{
    const res = await fetch(ENDPOINT,{
      method:"POST",
      headers:{
        "Content-Type":"application/json"
      },
      body: JSON.stringify({ text })
    });

    const data = await res.json();

    if(data.ok){
      result.textContent = data.reply;
      state.textContent = "";
    }else{
      result.textContent =
        "うまく返答できませんでした。\n\n" +
        (data.openai_error || "エラーが発生しました");
      state.textContent = "";
    }
  }catch(err){
    result.textContent =
      "通信エラーが発生しました。\n時間をおいて試してください。";
    state.textContent = "";
  }
};
</script>

</body>
</html>
